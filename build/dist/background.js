(()=>{"use strict";var e={729:e=>{var t=Object.prototype.hasOwnProperty,s="~";function n(){}function i(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function r(e,t,n,r,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new i(n,r||e,o),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(s=!1)),a.prototype.eventNames=function(){var e,n,i=[];if(0===this._eventsCount)return i;for(n in e=this._events)t.call(e,n)&&i.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=s?s+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,r=n.length,o=new Array(r);i<r;i++)o[i]=n[i].fn;return o},a.prototype.listenerCount=function(e){var t=s?s+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,i,r,o){var a=s?s+e:e;if(!this._events[a])return!1;var c,h,g=this._events[a],l=arguments.length;if(g.fn){switch(g.once&&this.removeListener(e,g.fn,void 0,!0),l){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,t),!0;case 3:return g.fn.call(g.context,t,n),!0;case 4:return g.fn.call(g.context,t,n,i),!0;case 5:return g.fn.call(g.context,t,n,i,r),!0;case 6:return g.fn.call(g.context,t,n,i,r,o),!0}for(h=1,c=new Array(l-1);h<l;h++)c[h-1]=arguments[h];g.fn.apply(g.context,c)}else{var _,w=g.length;for(h=0;h<w;h++)switch(g[h].once&&this.removeListener(e,g[h].fn,void 0,!0),l){case 1:g[h].fn.call(g[h].context);break;case 2:g[h].fn.call(g[h].context,t);break;case 3:g[h].fn.call(g[h].context,t,n);break;case 4:g[h].fn.call(g[h].context,t,n,i);break;default:if(!c)for(_=1,c=new Array(l-1);_<l;_++)c[_-1]=arguments[_];g[h].fn.apply(g[h].context,c)}}return!0},a.prototype.on=function(e,t,s){return r(this,e,t,s,!1)},a.prototype.once=function(e,t,s){return r(this,e,t,s,!0)},a.prototype.removeListener=function(e,t,n,i){var r=s?s+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||i&&!a.once||n&&a.context!==n||o(this,r);else{for(var c=0,h=[],g=a.length;c<g;c++)(a[c].fn!==t||i&&!a[c].once||n&&a[c].context!==n)&&h.push(a[c]);h.length?this._events[r]=1===h.length?h[0]:h:o(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,e.exports=a}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,s),r.exports}(()=>{class e{constructor(e){this.server=e,this.DEFAULT_OPTION={method:"GET",headers:{Accept:"application/json"}}}jsonFetch(e,t=this.DEFAULT_OPTION){return this._fetch(e,t)}_fetch(e,t){return new Promise(((s,n)=>{fetch(e,t).then((e=>{if(e,!e.ok)throw e.statusText;return e.json()})).then((e=>{if(null!=e.error)n({message:e.error.message||"",code:e.error.code||"",nr:e.error.nr||""});else{var t="object"==typeof e.result&&e.result.hasOwnProperty("data")?e.result.data:e.result;s(t)}})).catch((e=>{n({message:"_fetch: "+e.message,code:"500",nr:"-1"})}))}))}}class t{constructor(e,t){this.settings=e,this.transfer=t,this.debug=!1}getQueryTerms(){return new Promise(((e,t)=>{this.transfer.jsonFetch(this.settings.server+"bot/getqueryterms",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({})}).then((t=>{e(t)})).catch((t=>{console.warn("Failed fetching the queryterms"),e([])}))}))}getUrlList(){return new Promise(((e,t)=>{this.transfer.jsonFetch(this.settings.server+"bot/geturllist",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({})}).then((t=>{e(t)})).catch((t=>{console.warn("Failed fetching the urllist"),e([])}))}))}getEngines(){return new Promise(((e,t)=>{this.transfer.jsonFetch(this.settings.server+"bot/getengines",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({})}).then((t=>{e(t)})).catch((t=>{console.warn("Failed fetching the engines"),e([])}))}))}getBasePage(){return"/nextround.html"}clear_browser(){if(this.settings.clear_browser)try{console.log("Removing Chrome Data"),window.chrome.browsingData.remove({originTypes:{protectedWeb:!0,unprotectedWeb:!0,extension:!1}},{appcache:!0,cache:!0,cacheStorage:!0,cookies:!0,fileSystems:!0,formData:!0,history:!0,indexedDB:!0,localStorage:!0,pluginData:!0,passwords:!0,serviceWorkers:!0,webSQL:!0},(function(){console.log("Chrome data is Deleted...")}))}catch(e){console.log("Removing Firefox Data"),window.browser.browsingData.remove({originTypes:{unprotectedWeb:!0}},{cache:!0,cookies:!0,formData:!0,history:!0,indexedDB:!0,localStorage:!0,pluginData:!0,passwords:!0},(function(){console.log("Firefox data is Deleted...")}))}else console.log("NOT DELETING BROWSING DATA! Check settings.clear_browser")}}const n=s(729),i="onDisconnectPopup",r="onConnectedPopup";class o{constructor(){this.allow=!0,this.disabled=!1,this.content_blocked=!1}setState(e,t){this[e]=t}getState(e){return this[e]}}class a{constructor(e,t){this.config=e,this.tabs={},this.event=new n,this.keyword_iterator=0,this.keywords=t.keywords,this.engines=t.engines,console.log("using keywords:",this.keywords),console.log("using engines:",this.engines),this.engine="",this.keyword="",this.search_loop_activate=!1,this.starting_search_event=null,this.next_search_timeout=null,this.trigger_next_search_timeout=null,this.go_to_engine_and_retrigger_next_search_timeout=null,this.next_clear_browser=null,this.next_check_engine=null,this.search_tab_id=null,this._onContentMessage=this._onContentMessage.bind(this),this._onDisconnectPopup=this._onDisconnectPopup.bind(this),this._onConnectPopup=this._onConnectPopup.bind(this),this.getAllTabsIds=this.getAllTabsIds.bind(this),this.search_ticks=6e4*this.config.settings.search_ticks_mins,this.clear_browser_lapse=this.search_ticks-45e3,this.check_engine_lapse=this.search_ticks-3e4,this.initial_search_delay=6e4,this.step_iterators={},this.debug=!1}clear_browser(){console.log("-> Extension.clear_browser()"),this.config.clear_browser(),this.next_clear_browser&&(console.log("Removing Browser Event (this.next_clear_browser)"),clearTimeout(this.next_clear_browser))}set_settings(e){const t=this.config.settings.server!=e.server,s=e.clearBrowser&!this.config.settings.clear_browser;this.debug&&(console.log("before:"),console.log("this.keywords:",this.keywords,"this.keyword_iterator:",this.keyword_iterator),console.log("this.engines:",this.engines),console.log("this.config.settings:",this.config.settings)),this.keywords=e.queryTerms.split(",").map((e=>e.trim())),this.keyword_iterator=0,console.log(this.keywords,this.keyword_iterator),this.engines=e.searchEngines.filter((({active:e})=>e)).map((({url:e})=>e)),console.log(this.engines),e.useServer||(e.server=""),this.config.settings.server=e.server,this.config.settings.clear_browser=e.clearBrowser,this.config.settings.download=e.download,this.config.settings.close_inactive_tabs=e.closeInactiveTabs,this.config.settings.search_ticks_mins=e.searchTicksMins;try{window.localStorage.setItem("extension_settings",JSON.stringify(e)),console.log("persisted settings in localStorage")}catch(e){console.warn(e)}t&&(console.log("reloading engines and keywords from server"),new Promise(((e,t)=>{this.config.getEngines().then((t=>{this.engines=t,console.log("got engines:",t),e()}))})),new Promise(((e,t)=>{this.config.getQueryTerms().then((t=>{this.keywords=t,console.log("got keywords:",t),e()}))}))),s&&(console.log("clearing browser now"),this.config.clear_browser()),this.debug&&(console.log("after:"),console.log(this.config.settings))}get_settings(){let e=[{name:"Google",url:"https://google.com",active:!1},{name:"DuckDuckGo",url:"https://duckduckgo.com",active:!1},{name:"Bing",url:"https://bing.com",active:!1},{name:"Yandex",url:"https://yandex.com",active:!1},{name:"Yahoo",url:"https://search.yahoo.com",active:!1},{name:"Baidu",url:"https://baidu.com",active:!1}];for(let t in this.engines)e=e.map((({name:e,url:s,active:n})=>s==this.engines[t]?{name:e,url:s,active:!0}:{name:e,url:s,active:n}));return{queryTerms:this.keywords.join(", "),searchEngines:e,clearBrowser:!!this.config.settings.clear_browser&&this.config.settings.clear_browser,download:!!this.config.settings.download&&this.config.settings.download,closeInactiveTabs:!!this.config.settings.close_inactive_tabs&&this.config.settings.close_inactive_tabs,searchTicksMins:this.config.settings.search_ticks_mins?this.config.settings.search_ticks_mins:5,server:this.config.settings.server?this.config.settings.server:"",useServer:""!=this.config.settings.server}}_onConnectPopup(e){this.debug&&console.log("--\x3e_onConnectPopup:",e),"extension_popup"==e.name&&(e.onDisconnect.addListener(this._onDisconnectPopup),this.event.emit(r)),this.debug&&console.log("<--_onConnectPopup:")}_onDisconnectPopup(e){this.debug&&console.log("--\x3e_onDisconnectPopup:",e),"extension_popup"==e.name&&(e.onDisconnect.removeListener(this._onDisconnectPopup),this.event.emit(i)),this.debug&&console.log("<--_onDisconnectPopup")}getAllTabsIds(e={},t=!0){return new Promise(((s,n)=>{xbrowser.tabs.query(e,(e=>{s(t?e.map((e=>e.id)):e)}))}))}arrayRotate(e,t){return t-=e.length*Math.floor(t/e.length),e.push.apply(e,e.splice(0,t)),e}start_search_loop(e=6e4){let t=new Date,s=t.getTime()%e;console.log("Now:",t),this.starting_search_event=t.getTime()-s+e,console.log("Starting Search Event:",new Date(this.starting_search_event),this.engine,this.get_next_term()),console.log("...which in milliseconds is",this.starting_search_event),this.config.settings.close_inactive_tabs&&this.getAllTabsIds({active:!1}).then((e=>{for(let t of e)xbrowser.tabs.remove(t)}));let n=e-s;this.next_search_timeout=setTimeout(function(){this.trigger_next_search(),this.search_loop(t.getTime()-s+e)}.bind(this),n)}search_loop(e){let t=new Date;console.log("Next Search Event:",new Date(e+this.search_ticks),this.get_next_engine(),this.get_next_term()),this.next_search_timeout=setTimeout(function(){this.next_search(),this.search_loop(e+this.search_ticks)}.bind(this),e+this.search_ticks-t.getTime()),console.log("Next Browsing Cleaning:",new Date(e+this.clear_browser_lapse)),this.next_clear_browser=setTimeout(function(){this.trigger_clear_browser()}.bind(this),e+this.clear_browser_lapse-t.getTime()),console.log("Next Check Engine Event:",new Date(e+this.check_engine_lapse)),this.next_check_engine=setTimeout(function(){this.trigger_check_next_engine()}.bind(this),e+this.check_engine_lapse-t.getTime())}get_next_term(){let e=this.keyword_iterator+1;return e>=this.keywords.length&&(e=0),this.keywords[e]}_clean_www(e){return e.startsWith("www.")?e.substr(4):e}get_engine_index(){let e=this.engines.indexOf(this.engine);if(-1==e){console.log("Engine not found, looking for the canonical form");let t="https://"+this._clean_www(new URL(this.engine).hostname);e=this.engines.indexOf(t)}return e}get_next_engine(){let e=this.get_engine_index();return e+=1,e>=this.engines.length&&(e=0),this.engines[e]}next_search(){this.keyword_iterator=this.keyword_iterator+1,this.keyword_iterator>=this.keywords.length&&(this.keyword_iterator=0),this.keyword=this.keywords[this.keyword_iterator],this.engine=this.get_next_engine(this.engine),this.trigger_next_search()}async trigger_clear_browser(){console.log("trigger_clear_browser(): NEW");try{xbrowser.tabs.update(this.search_tab_id,{url:this.config.getBasePage()})}catch(e){console.log("Caught error (trigger_clear_browser):",e)}}async trigger_check_next_engine(){console.log("trigger_check_next_engine");try{xbrowser.tabs.get(this.search_tab_id,function(e){let t=this.get_next_engine(),s=new URL(t);if(xbrowser.runtime.lastError)try{xbrowser.tabs.update(this.search_tab_id,{url:t})}catch(e){console.log("Caught error 1 (trigger_check_next_engine):",e)}var n=new URL(e.url);if(this._clean_www(n.hostname)==this._clean_www(s.hostname)&&"/"==n.pathname)console.log("this is the correct engine:",s.hostname);else{console.log("wrong engine (main page)",this._clean_www(n.hostname),this._clean_www(s.hostname));try{xbrowser.tabs.update(this.search_tab_id,{url:t})}catch(e){console.log("Caught error 2 (trigger_check_next_engine):",e)}}}.bind(this))}catch(e){console.log("Caught error 3 (trigger_check_next_engine):",e)}}go_to_engine_and_retrigger_next_search(e,t){try{xbrowser.tabs.update(this.search_tab_id,{url:e},function(e){xbrowser.runtime.lastError?this.go_to_engine_and_retrigger_next_search_timeout=setTimeout(function(){this.trigger_next_search()}.bind(this),3e4):(console.log("Interface not ready:  waiting for redirection"),this.trigger_next_search_timeout=setTimeout(function(){this.trigger_next_search()}.bind(this),3e4))}.bind(this))}catch(e){console.log("Caught error in go_to_engine_and_retrigger_next_search:",e)}}async trigger_frontend_next_search(e,t){console.log("trigger_frontend_next_search");try{xbrowser.tabs.sendMessage(this.search_tab_id,{action:"search",engine:e,keyword:t},function(s){xbrowser.runtime.lastError&&(this.debug&&console.log("trigger_next_search: No front end tab is listening. Try refreshing engine again"),this.go_to_engine_and_retrigger_next_search(e,t)),s||(console.log("Interface not ready:  waiting for redirection"),this.go_to_engine_and_retrigger_next_search(e,t))}.bind(this))}catch(e){console.log("Caught error (trigger_frontend_next_search):",e)}}check_keyword_engine_synchronization(){let e=new Date-this.starting_search_event,t=Math.floor(e/this.search_ticks),s=t%this.keywords.length,n=t%this.engines.length;console.log("keywords:",this.keywords[this.keyword_iterator],"vs",this.keywords[s]);let i=!0;this.keyword_iterator!=s?(console.log("Resynchronization of keyword iterator required"),this.keyword_iterator=s,i=!1):(console.log("keyword is synchronized"),i=!0);let r=new URL(this.engine).hostname,o=new URL(this.engines[n]).hostname;return console.log("engines:",this.engine,"vs",this.engines[n]),this._clean_www(r)!=this._clean_www(o)?(console.log("Resynchronization of engine iterator required"),this.engine=this.engines[n],i=!1):(console.log("engine is synchronized"),i=!0),i}async trigger_next_search(){console.log("trigger_next_search"),this.check_keyword_engine_synchronization()||console.log("the keyword or engine were no longer syncrhonized");let e=this.keywords[this.keyword_iterator],t=this.engine;this.step_iterators={};try{xbrowser.tabs.get(this.search_tab_id,function(s){xbrowser.runtime.lastError&&this.go_to_engine_and_retrigger_next_search(t,e);var n=new URL(s.url);console.log("tabs.get()",n.pathname);let i=new URL(t).hostname;this._clean_www(n.hostname)==this._clean_www(i)&&"/"==n.pathname?(console.log("this is the correct location to be:",e,t),this.trigger_frontend_next_search(t,e)):(console.log("not the correct location (main page)",this._clean_www(n.hostname),this._clean_www(i)),this.go_to_engine_and_retrigger_next_search(t,e))}.bind(this))}catch(e){console.log("Caught error (trigger_next_search):",e)}}_onContentMessage(e,t,s){if(this.debug&&console.log("-> _onContentMessage"),"on_start"===e)s({clear_browser_flag:this.config.settings.clear_browser,server:this.config.settings.server});else if(e.hasOwnProperty("steady"))console.log("engine:",this.engine),console.log("msg.engine:",e.engine),this.search_loop_activate?s(!1):(this.engine=e.engine,this.engines=this.arrayRotate(this.engines,this.get_engine_index()),console.log("Engine order:",this.engines),this.search_loop_activate=!0,this.keyword_iterator=0,this.keyword=this.keywords[this.keyword_iterator],this.search_tab_id=t.tab.id,this.start_search_loop(),s(!0));else if(e.hasOwnProperty("clear_browser"))this.clear_browser(),s(!0);else if(e.hasOwnProperty("set_iter_step")){e.step in this.step_iterators?this.step_iterators[e.step]+=1:this.step_iterators[e.step]=0;let t=this.step_iterators[e.step];console.log("set_iter_step",e.step,t),s({iterator:t})}else if(e.hasOwnProperty("get_iter_step")){let t=this.step_iterators[e.step];console.log("get_iter_step",e.step,t),s({iterator:t})}else if(e.hasOwnProperty("go_to_base_page")){let e=this.config.getBasePage();console.log("go_to_base_page",e),xbrowser.tabs.update(this.search_tab_id,{url:this.config.getBasePage()}),s({base_page:e})}else if(e.hasOwnProperty("get_current_search"))console.log("get_current_search:",this.engine,this.keyword),s({current_engine:this.engine,current_keyword:this.keyword});else if(e.hasOwnProperty("get_next_engine")){let e=this.get_next_engine();console.log("get_next_engine",e),s({next_engine:e})}else e.hasOwnProperty("update_settings")?e.hasOwnProperty("settings")?(console.log("updating settings"),this.set_settings(e.settings),s(!0)):s(!1):e.hasOwnProperty("get_settings")&&(console.log("getting settings"),s(this.get_settings()));return this.debug&&console.log("<- _onContentMessage"),!0}start(){return new Promise(((e,t)=>{xbrowser.runtime.onMessage.addListener(this._onContentMessage),xbrowser.runtime.onConnect.addListener(this._onConnectPopup),xbrowser.browserAction.onClicked.addListener((()=>{xbrowser.runtime.openOptionsPage()})),this.getAllTabsIds().then((e=>{for(let t of e)this.tabs[t]=new o})),e()}))}}class c{constructor(e,t){this.config=e,this.debug=!1,this.urllist=t.urllist,this.navlists=t}async reload_config(){try{this.debug&&console.log("***Load Configuration***"),this.debug&&console.log("***Configuration Loaded***")}catch(e){console.log("ERROR IN INIT"),console.error(e)}}async init(){this.debug&&console.log("ExtensionHandler.init()"),await this.reload_config(),this.initialize()}initialize(){return new Promise(((e,t)=>{this.debug&&console.log("-> ExtensionHandler.initialize() - Promise");try{this.extension=new a(this.config,this.navlists),this.extension.start()}catch(e){t(e)}finally{this.debug&&console.log("<- ExtensionHandler.initialize() - Promise"),e()}}))}track_list(){return this.debug&&console.log("-> ExtensionHandler.track_list()"),new Promise(((e,t)=>{this.navigate(),e(!0)}))}navigate(){return new Promise(((e,t)=>{xbrowser.tabs.query({currentWindow:!0,active:!0},function(e){let t=0;xbrowser.tabs.update(e[0].id,{url:s});let s=this.urllist[t];s.startsWith("http")||(s="http://"+s),xbrowser.tabs.update(e[0].id,{url:s}),t+=1,t==this.urllist.length&&clearInterval(n);let n=setInterval(function(){let s=this.urllist[t];s.startsWith("http")||(s="http://"+s),xbrowser.tabs.update(e[0].id,{url:s}),t+=1,t==this.urllist.length&&clearInterval(n)}.bind(this),1e4)}.bind(this))}))}}!async function(){const{base_settings:s,restored_settings:n}=function(){let e=null;try{e=JSON.parse(window.localStorage.getItem("extension_settings"))}catch(e){console.warn(e)}return e||(console.warn("Could not restore settings from local storage, using default values."),e={useServer:!1,searchEngines:[{name:"Google",url:"https://google.com",active:!0},{name:"DuckDuckGo",url:"https://duckduckgo.com",active:!0},{name:"Bing",url:"https://bing.com",active:!0},{name:"Yandex",url:"https://yandex.com",active:!1},{name:"Yahoo",url:"https://search.yahoo.com",active:!1},{name:"Baidu",url:"https://baidu.com",active:!1}],queryTerms:"Sage Concept Grant, elections",server:"",searchTicksMins:5,clearBrowser:!1,closeInactiveTabs:!1,download:!1}),{base_settings:{server:e.server,search_ticks_mins:e.searchTicksMins,clear_browser:e.clearBrowser,close_inactive_tabs:e.closeInactiveTabs,download:e.download},restored_settings:e}}();console.log("Start",new Date);var i=new e(s.server);window.config=new t(s,i),window.config.clear_browser(),window.addEventListener("unhandledrejection",(e=>{console.warn("UNHANDLED PROMISE REJECTION: ",e.reason,". Have you added the certificates by visiting the server page?")})),window.xbrowser=window.hasOwnProperty("chrome")?chrome:browser,window.settings=s;let r={keywords:[],engines:[]};n.useServer?(console.log("Loading engines & keywords from server:",s.server),r.keywords=await config.getQueryTerms(),r.engines=await config.getEngines()):(console.log("Restoring engines & keywords from localStorage"),r.keywords=n.queryTerms.split(",").map((e=>e.trim())),r.engines=n.searchEngines.filter((({active:e})=>e)).map((({url:e})=>e))),window.extensionHandler=new c(config,r),await window.extensionHandler.init()}()})()})();